{"version":3,"sources":["../src/tool_configure_controller.js"],"names":["define","$","ajax","pagedContentFactory","notification","templates","ltiEvents","KEYS","toolAll","toolType","toolProxy","str","SELECTORS","EXTERNAL_REGISTRATION_CONTAINER","EXTERNAL_REGISTRATION_PAGE_CONTAINER","EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER","CARTRIDGE_REGISTRATION_CONTAINER","CARTRIDGE_REGISTRATION_FORM","ADD_TOOL_FORM","TOOL_CARD_CONTAINER","TOOL_LIST_CONTAINER","TOOL_CREATE_BUTTON","TOOL_CREATE_LTILEGACY_BUTTON","REGISTRATION_CHOICE_CONTAINER","TOOL_URL","getToolListContainer","getToolCardContainer","getExternalRegistrationContainer","getCartridgeRegistrationContainer","getRegistrationChoiceContainer","closeLTIAdvRegistration","e","data","subject","empty","hideExternalRegistration","showRegistrationChoices","showToolList","reloadToolList","initiateRegistration","url","removeClass","container","append","encodeURIComponent","showExternalRegistration","window","addEventListener","getToolURL","val","addClass","hideCartridgeRegistration","hideRegistrationChoices","screenReaderAnnounce","showCartridgeRegistration","find","attr","element","children","detach","appendTo","hideToolList","showRegistrationFeedback","type","error","addNotification","message","startLoading","stopLoading","cardContainer","listContainer","fetchToolCount","done","createWithTotalAndLimit","count","pagesData","map","pageData","fetchToolData","limit","offset","then","renderToolData","html","js","replaceNodeContents","always","query","context","tools","types","proxies","render","addLTIAdvTool","trim","addLTILegacyTool","Deferred","resolve","toolButton","promise","isCartridge","result","iscartridge","document","trigger","START_CARTRIDGE_REGISTRATION","START_EXTERNAL_REGISTRATION","fail","get_string","s","REGISTRATION_FEEDBACK","exception","registerEventListeners","on","NEW_TOOL_TYPE","STOP_EXTERNAL_REGISTRATION","event","STOP_CARTRIDGE_REGISTRATION","removeAttr","addLegacyButton","click","preventDefault","addLTIButton","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Standard Ajax wrapper for Moodle. It calls the central Ajax script,\n * which can call any existing webservice using the current session.\n * In addition, it can batch multiple requests and return multiple responses.\n *\n * @module     mod_lti/tool_configure_controller\n * @class      tool_configure_controller\n * @package    mod_lti\n * @copyright  2015 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/ajax', 'core/paged_content_factory', 'core/notification', 'core/templates', 'mod_lti/events',\n        'mod_lti/keys', 'mod_lti/tool_all', 'mod_lti/tool_type', 'mod_lti/tool_proxy', 'core/str'],\n        function($, ajax, pagedContentFactory, notification, templates, ltiEvents, KEYS, toolAll, toolType, toolProxy, str) {\n\n    var SELECTORS = {\n        EXTERNAL_REGISTRATION_CONTAINER: '#external-registration-container',\n        EXTERNAL_REGISTRATION_PAGE_CONTAINER: '#external-registration-page-container',\n        EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER: '#external-registration-template-container',\n        CARTRIDGE_REGISTRATION_CONTAINER: '#cartridge-registration-container',\n        CARTRIDGE_REGISTRATION_FORM: '#cartridge-registration-form',\n        ADD_TOOL_FORM: '#add-tool-form',\n        TOOL_CARD_CONTAINER: '#tool-card-container',\n        TOOL_LIST_CONTAINER: '#tool-list-container',\n        TOOL_CREATE_BUTTON: '#tool-create-button',\n        TOOL_CREATE_LTILEGACY_BUTTON: '#tool-createltilegacy-button',\n        REGISTRATION_CHOICE_CONTAINER: '#registration-choice-container',\n        TOOL_URL: '#tool-url'\n    };\n\n    /**\n     * Get the tool list container element.\n     *\n     * @method getToolListContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getToolListContainer = function() {\n        return $(SELECTORS.TOOL_LIST_CONTAINER);\n    };\n\n    /**\n     * Get the tool card container element.\n     *\n     * @method getToolCardContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getToolCardContainer = function() {\n        return $(SELECTORS.TOOL_CARD_CONTAINER);\n    };\n\n    /**\n     * Get the external registration container element.\n     *\n     * @method getExternalRegistrationContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getExternalRegistrationContainer = function() {\n        return $(SELECTORS.EXTERNAL_REGISTRATION_CONTAINER);\n    };\n\n    /**\n     * Get the cartridge registration container element.\n     *\n     * @method getCartridgeRegistrationContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getCartridgeRegistrationContainer = function() {\n        return $(SELECTORS.CARTRIDGE_REGISTRATION_CONTAINER);\n    };\n\n    /**\n     * Get the registration choice container element.\n     *\n     * @method getRegistrationChoiceContainer\n     * @private\n     * @return {Object} jQuery object\n     */\n    var getRegistrationChoiceContainer = function() {\n        return $(SELECTORS.REGISTRATION_CHOICE_CONTAINER);\n    };\n\n    /**\n     * Close the LTI Advantage Registration IFrame.\n     *\n     * @private\n     * @param {Object} e post message event sent from the registration frame.\n     */\n    var closeLTIAdvRegistration = function(e) {\n        if (e.data && 'org.imsglobal.lti.close' === e.data.subject) {\n            $(SELECTORS.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER).empty();\n            hideExternalRegistration();\n            showRegistrationChoices();\n            showToolList();\n            showRegistrationChoices();\n            reloadToolList();\n        }\n    };\n\n    /**\n     * Load the external registration template and render it in the DOM and display it.\n     *\n     * @method initiateRegistration\n     * @private\n     * @param {String} url where to send the registration request\n     */\n    var initiateRegistration = function(url) {\n        // Show the external registration page in an iframe.\n        $(SELECTORS.EXTERNAL_REGISTRATION_PAGE_CONTAINER).removeClass('hidden');\n        var container = $(SELECTORS.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER);\n        container.append($(\"<iframe src='startltiadvregistration.php?url=\"\n                         + encodeURIComponent(url) + \"'></iframe>\"));\n        showExternalRegistration();\n        window.addEventListener(\"message\", closeLTIAdvRegistration, false);\n    };\n\n    /**\n     * Get the tool type URL.\n     *\n     * @method getToolURL\n     * @private\n     * @return {String} the tool type url\n     */\n    var getToolURL = function() {\n        return $(SELECTORS.TOOL_URL).val();\n    };\n\n    /**\n     * Hide the external registration container.\n     *\n     * @method hideExternalRegistration\n     * @private\n     */\n    var hideExternalRegistration = function() {\n        getExternalRegistrationContainer().addClass('hidden');\n    };\n\n    /**\n     * Hide the cartridge registration container.\n     *\n     * @method hideCartridgeRegistration\n     * @private\n     */\n    var hideCartridgeRegistration = function() {\n        getCartridgeRegistrationContainer().addClass('hidden');\n    };\n\n    /**\n     * Hide the registration choice container.\n     *\n     * @method hideRegistrationChoices\n     * @private\n     */\n    var hideRegistrationChoices = function() {\n        getRegistrationChoiceContainer().addClass('hidden');\n    };\n\n    /**\n     * Display the external registration panel and hides the other\n     * panels.\n     *\n     * @method showExternalRegistration\n     * @private\n     */\n    var showExternalRegistration = function() {\n        hideCartridgeRegistration();\n        hideRegistrationChoices();\n        getExternalRegistrationContainer().removeClass('hidden');\n        screenReaderAnnounce(getExternalRegistrationContainer());\n    };\n\n    /**\n     * Display the cartridge registration panel and hides the other\n     * panels.\n     *\n     * @method showCartridgeRegistration\n     * @param {String} url\n     * @private\n     */\n    var showCartridgeRegistration = function(url) {\n        hideExternalRegistration();\n        hideRegistrationChoices();\n        // Don't save the key and secret from the last tool.\n        var container = getCartridgeRegistrationContainer();\n        container.find('input').val('');\n        container.removeClass('hidden');\n        container.find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).attr('data-cartridge-url', url);\n        screenReaderAnnounce(container);\n    };\n\n    /**\n     * Display the registration choices panel and hides the other\n     * panels.\n     *\n     * @method showRegistrationChoices\n     * @private\n     */\n    var showRegistrationChoices = function() {\n        hideExternalRegistration();\n        hideCartridgeRegistration();\n        getRegistrationChoiceContainer().removeClass('hidden');\n        screenReaderAnnounce(getRegistrationChoiceContainer());\n    };\n\n    /**\n     * JAWS does not notice visibility changes with aria-live.\n     * Remove and add the content back to force it to read it out.\n     * This function can be removed once JAWS supports visibility.\n     *\n     * @method screenReaderAnnounce\n     * @param {Object} element\n     * @private\n     */\n    var screenReaderAnnounce = function(element) {\n        var children = element.children().detach();\n        children.appendTo(element);\n    };\n\n    /**\n     * Hides the list of tool types.\n     *\n     * @method hideToolList\n     * @private\n     */\n    var hideToolList = function() {\n        getToolListContainer().addClass('hidden');\n    };\n\n    /**\n     * Display the list of tool types.\n     *\n     * @method hideToolList\n     * @private\n     */\n    var showToolList = function() {\n        getToolListContainer().removeClass('hidden');\n    };\n\n    /**\n     * Display the registration feedback alert and hide the other panels.\n     *\n     * @method showRegistrationFeedback\n     * @param {Object} data\n     * @private\n     */\n    var showRegistrationFeedback = function(data) {\n        var type = data.error ? 'error' : 'success';\n        notification.addNotification({\n            message: data.message,\n            type: type\n        });\n    };\n\n    /**\n     * Show the loading animation\n     *\n     * @method startLoading\n     * @private\n     * @param {Object} element jQuery object\n     */\n    var startLoading = function(element) {\n        element.addClass(\"loading\");\n    };\n\n    /**\n     * Hide the loading animation\n     *\n     * @method stopLoading\n     * @private\n     * @param {Object} element jQuery object\n     */\n    var stopLoading = function(element) {\n        element.removeClass(\"loading\");\n    };\n\n    /**\n     * Refresh the list of tool types and render the new ones.\n     *\n     * @method reloadToolList\n     * @private\n     */\n    var reloadToolList = function() {\n        var cardContainer = getToolCardContainer();\n        var listContainer = getToolListContainer();\n        var limit = 60;\n        // Get initial data with zero limit and offset.\n        fetchToolCount().done(function(data) {\n            pagedContentFactory.createWithTotalAndLimit(\n                data.count,\n                limit,\n                function(pagesData) {\n                    return pagesData.map(function(pageData) {\n                        return fetchToolData(pageData.limit, pageData.offset)\n                            .then(function(data) {\n                                return renderToolData(data);\n                            });\n                    });\n                },\n                {\n                    'showFirstLast': true\n                })\n                .done(function(html, js) {\n                // Add the paged content into the page.\n                templates.replaceNodeContents(cardContainer, html, js);\n                })\n                .always(stopLoading(listContainer));\n        });\n        startLoading(listContainer);\n    };\n\n    /**\n     * Fetch the count of tool type and proxy datasets.\n     *\n     * @return {*|void}\n     */\n    var fetchToolCount = function() {\n        return toolAll.count({'orphanedonly': true})\n            .done(function(data) {\n                return data;\n            });\n    };\n\n    /**\n     * Fetch the data for tool type and proxy cards.\n     *\n     * @param {number} limit Maximum number of datasets to get.\n     * @param {number} offset Offset count for fetching the data.\n     * @return {*|void}\n     */\n    var fetchToolData = function(limit, offset) {\n        return toolAll.query({'orphanedonly': true, 'limit': limit, 'offset': offset})\n            .done(function(data) {\n                return data;\n            });\n    };\n\n    /**\n     * Render Tool and Proxy cards from data.\n     *\n     * @param {Object} data Contains arrays of data objects to populate cards.\n     * @return {*}\n     */\n    var renderToolData = function(data) {\n        var context = {\n            tools: data.types,\n            proxies: data.proxies,\n        };\n        return templates.render('mod_lti/tool_list', context)\n            .done(function(html, js) {\n                    return {html, js};\n                }\n            );\n    };\n\n    /**\n     * Start the LTI Advantage registration.\n     *\n     * @method addLTIAdvTool\n     * @private\n     */\n    var addLTIAdvTool = function() {\n        var url = $.trim(getToolURL());\n\n        if (url) {\n            $(SELECTORS.TOOL_URL).val('');\n            hideToolList();\n            initiateRegistration(url);\n        }\n\n    };\n\n    /**\n     * Trigger appropriate registration process process for the user input\n     * URL. It can either be a cartridge or a registration url.\n     *\n     * @method addLTILegacyTool\n     * @private\n     * @return {Promise} jQuery Deferred object\n     */\n    var addLTILegacyTool = function() {\n        var url = $.trim(getToolURL());\n\n        if (url === \"\") {\n            return $.Deferred().resolve();\n        }\n        var toolButton = $(SELECTORS.TOOL_CREATE_LTILEGACY_BUTTON);\n        startLoading(toolButton);\n\n        var promise = toolType.isCartridge(url);\n\n        promise.always(function() {\n          stopLoading(toolButton);\n        });\n\n        promise.done(function(result) {\n            if (result.iscartridge) {\n                $(SELECTORS.TOOL_URL).val('');\n                $(document).trigger(ltiEvents.START_CARTRIDGE_REGISTRATION, url);\n            } else {\n                $(document).trigger(ltiEvents.START_EXTERNAL_REGISTRATION, {url: url});\n            }\n        });\n\n        promise.fail(function() {\n            str.get_string('errorbadurl', 'mod_lti')\n                .done(function(s) {\n                        $(document).trigger(ltiEvents.REGISTRATION_FEEDBACK, {\n                                message: s,\n                                error: true\n                            });\n                    })\n                .fail(notification.exception);\n        });\n\n        return promise;\n    };\n\n    /**\n     * Sets up the listeners for user interaction on the page.\n     *\n     * @method registerEventListeners\n     * @private\n     */\n    var registerEventListeners = function() {\n\n        // These are events fired by the registration processes. Either\n        // the cartridge registration or the external registration url.\n        $(document).on(ltiEvents.NEW_TOOL_TYPE, function() {\n            reloadToolList();\n        });\n\n        $(document).on(ltiEvents.START_EXTERNAL_REGISTRATION, function() {\n            showExternalRegistration();\n            $(SELECTORS.TOOL_URL).val('');\n            hideToolList();\n        });\n\n        $(document).on(ltiEvents.STOP_EXTERNAL_REGISTRATION, function() {\n            showToolList();\n            showRegistrationChoices();\n        });\n\n        $(document).on(ltiEvents.START_CARTRIDGE_REGISTRATION, function(event, url) {\n            showCartridgeRegistration(url);\n        });\n\n        $(document).on(ltiEvents.STOP_CARTRIDGE_REGISTRATION, function() {\n            getCartridgeRegistrationContainer().find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).removeAttr('data-cartridge-url');\n            showRegistrationChoices();\n        });\n\n        $(document).on(ltiEvents.REGISTRATION_FEEDBACK, function(event, data) {\n            showRegistrationFeedback(data);\n        });\n\n        var addLegacyButton = $(SELECTORS.TOOL_CREATE_LTILEGACY_BUTTON);\n        addLegacyButton.click(function(e) {\n            e.preventDefault();\n            addLTILegacyTool();\n        });\n\n        var addLTIButton = $(SELECTORS.TOOL_CREATE_BUTTON);\n        addLTIButton.click(function(e) {\n            e.preventDefault();\n            addLTIAdvTool();\n        });\n\n    };\n\n    return /** @alias module:mod_lti/cartridge_registration_form */ {\n\n        /**\n         * Initialise this module.\n         */\n        init: function() {\n            registerEventListeners();\n            reloadToolList();\n        }\n    };\n});\n"],"file":"tool_configure_controller.min.js"}